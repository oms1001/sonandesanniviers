<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Mapa interactivo</title>
    <style>
      body {
        margin: 0;
      }
    </style>

    <link rel="stylesheet" href="stylegeneral.css" />

    <script src="https://unpkg.com/jquery@3.3.1/dist/jquery.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
      <div class="guia">
        <h1>Guía</h1>
        <ul>
          <li>
            <a href="#">Event #1: Bolivian raclette </a>
          </li>
          <li>
            <a href="#">Event #2: Mountain communities, from autarky to autonomy</a>
          </li>
          <li>
            <a href="#">Event #3: The commons, community management of the ressources</a>
          </li>
        </ul>
      </div>
      <div  class="popup" id="grand_mountet">

        <h1 class="titulo">Grand Mountet</h1>
                <p>
          Lorem ipsum dolor sit amet, consectetur adipiscing elit. Ut imperdiet
          ultrices neque nec maximus. Nunc metus nibh, facilisis non tortor
          quis, accumsan dictum ipsum. Aenean sodales tellus vitae ullamcorper
          porta. In fermentum ac sapien at lacinia. Quisque placerat libero
          ligula, id bibendum neque iaculis non. Fusce nibh est, commodo euismod
          gravida vitae, blandit sed sapien. Integer laoreet interdum efficitur.
          Pellentesque nec lectus vehicula purus consequat pellentesque. Mauris
          varius ac mi at pretium.
        </p>

      </div>

      <div  class="popup" id="zinal">
        <h1 class="titulo">Zinal</h1>
        <iframe src="https://www.youtube.com/embed/DH0BQtwEAsM" title="YouTube video player" controls ="0" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope" ></iframe>
        <p>
          Lorem ipsum dolor sit amet, consectetur adipiscing elit. Ut imperdiet
          ultrices neque nec maximus. Nunc metus nibh, facilisis non tortor
          quis, accumsan dictum ipsum. Aenean sodales tellus vitae ullamcorper
          porta. In fermentum ac sapien at lacinia. Quisque placerat libero
          ligula, id bibendum neque iaculis non. Fusce nibh est, commodo euismod
          gravida vitae, blandit sed sapien. Integer laoreet interdum efficitur.
          Pellentesque nec lectus vehicula purus consequat pellentesque. Mauris
          varius ac mi at pretium.
        </p>

        <p>
          Interdum et malesuada fames ac ante ipsum primis in faucibus. Donec
          iaculis dolor ac justo finibus commodo. Cras eget tempus dui.
          Phasellus accumsan finibus mattis. Suspendisse potenti. Curabitur
          maximus, urna non tempor euismod, velit felis congue diam, ac aliquet
          nunc libero ac ex. Fusce sit amet velit sed arcu porttitor eleifend ac
          quis neque. Donec accumsan nunc nibh, sit amet ultricies urna
          dignissim et. Cras ac maximus ipsum.
        </p>
      </div>

    <script
      async
      src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"
    ></script>

    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.143.0/build/three.module.js"
        }
      }
    </script>

    <script type="module">
      import * as THREE from "three";
      // https://unpkg.com/three@0.143.0/examples/jsm/loaders/GLTFLoader.js
      // import { OrbitControls } from 'https://unpkg.com/three@0.143.0/examples/jsm/controls/OrbitControls'
      import { GLTFLoader } from "https://unpkg.com/three@0.143.0/examples/jsm/loaders/GLTFLoader.js";
      import { OrbitControls } from "https://unpkg.com/three@0.143.0/examples/jsm/controls/OrbitControls.js";
      import Stats from "https://unpkg.com/three@0.143.0/examples/jsm/libs/stats.module";
      import { Interaction } from "https://unpkg.com/three.interaction@0.2.2/src/index.js";
      import { EffectComposer } from "https://unpkg.com/three@0.143.0/examples/jsm/postprocessing/EffectComposer.js";
      import { RenderPass } from "https://unpkg.com/three@0.143.0/examples/jsm/postprocessing/RenderPass.js";
      import { BokehPass } from "https://unpkg.com/three@0.143.0/examples/jsm/postprocessing/BokehPass.js";

      const scene = new THREE.Scene();
      //const fondo = new THREE.TextureLoader().load( "textures/alps_field_1k.png" );
      //scene.background = fondo

      const light = new THREE.AmbientLight(0xa4a4a4); // soft white light
      scene.add(light);

      const geometry = new THREE.SphereGeometry(0.5, 32, 16);
      const material_normal = new THREE.MeshBasicMaterial({ color: 0x275686 });
      const material_hover = new THREE.MeshBasicMaterial({ color: 0x287bd0 });

      const axesHelper = new THREE.AxesHelper(5);
      scene.add(axesHelper);

      // Esferas
      const sphere = new THREE.Mesh(geometry, material_normal);
      scene.add(sphere);

      sphere.position.y = 6;
      sphere.position.x = 10;
      sphere.position.z = 10;

      const material_zinal = new THREE.MeshBasicMaterial({ color: 0xe31a61 });
      const sphere_zinal = new THREE.Mesh(geometry, material_zinal);
      scene.add(sphere_zinal);

      sphere_zinal.position.y = 3;
      sphere_zinal.position.x = 20;
      sphere_zinal.position.z = -6;

      sphere_zinal.on("click", function (ev) {
        console.log("click en esfera");
        show_zinal();
      });

      sphere_zinal.on("mouseover", function (ev) {
        material_normal.color.setHex(0x1a75ff);
      });

      // Cámara

      const camera = new THREE.PerspectiveCamera(
        75,
        window.innerWidth / window.innerHeight,
        0.1,
        1000
      );

      camera.position.set(18, 15, -25);
      //camera.rotation.y = Math.PI * 2;
      camera.rotation.set(90, 45, 0);

      const renderer = new THREE.WebGLRenderer();
      //renderer.physicallyCorrectLights = true
      renderer.shadowMap.enabled = true;
      renderer.outputEncoding = THREE.sRGBEncoding;
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      const controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.minPolarAngle = -Math.PI;
      controls.minDistance = 20;
      controls.maxDistance = 60;

      const loader = new GLTFLoader();
      let mixer;
      loader.load(
        "models/map/anniviers_optimized.glb",
        function (gltf) {
          gltf.scene.scale.set(0.009, 0.009, 0.009);
          // gltf.scene.position.x = 0;
          const model = gltf.scene;
          scene.add(model);
          mixer = new THREE.AnimationMixer(model);
          const clips = gltf.animations;

          clips.forEach(function (clip) {
            const action = mixer.clipAction(clip);
            action.play();
          });
        },
        (xhr) => {
          console.log((xhr.loaded / xhr.total) * 100 + "% loaded");
        },
        (error) => {
          console.log(error);
        }
      );

      window.addEventListener("resize", onWindowResize, false);
      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
        render();
      }

      renderer.setAnimationLoop(animate);

      // Prueba de interacción

      const clock = new THREE.Clock();
      function animate() {
        //requestAnimationFrame(animate)

        controls.update();
        if (mixer) mixer.update(clock.getDelta());

        render();
      }

      const interaction = new Interaction(renderer, scene, camera);

      function show_zinal() {
        $(document).ready(function () {
          $("#zinal").toggle();
        });
      }
      function show_mountet() {
        $(document).ready(function () {
          $("#grand_mountet").toggle();
        });
      }

      sphere.on("click", function (ev) {
        console.log("click en esfera");
        show_mountet();
      });

      sphere.on("mouseover", function (ev) {
        material_normal.color.setHex(0x1a75ff);
      });

      animate();

      // Postprocessing

      const postprocessing = {};

      function initPostprocessing() {
        const renderPass = new RenderPass(scene, camera);

        const bokehPass = new BokehPass(scene, camera, {
          focus: 1.0,
          aperture: 0.025,
          maxblur: 0.01,

          width: width,
          height: height,
        });

        const composer = new EffectComposer(renderer);

        composer.addPass(renderPass);
        composer.addPass(bokehPass);

        postprocessing.composer = composer;
        postprocessing.bokeh = bokehPass;
      }

      function render() {
        renderer.render(scene, camera);
        //initPostprocessing();
        function animate() {
          composer.render();
          requestAnimationFrame(animate);
        }

        //postprocessing.composer.render( 0.1 );
      }
    </script>
  </body>
</html>
